"use strict";(()=>{var a=document.getElementById("sync-status"),d=document.getElementById("port-input"),f=document.getElementById("open-btn"),n=document.getElementById("sync-btn"),m,c=3001;function S(t){let o=new Date(t),e=Date.now()-o.getTime(),s=Math.floor(e/1e3),r=Math.floor(s/60),g=Math.floor(r/60);return s<60?"Synced just now":r<60?`Synced ${r}m ago`:g<24?`Synced ${g}h ago`:`Synced ${o.toLocaleDateString()}`}function u(t){t?.lastSyncedAt?(a.textContent=`${S(t.lastSyncedAt)} (${t.entryCount} entries)`,a.className="status synced"):(a.textContent="Not synced yet. Open your tracker app to sync.",a.className="status")}function l(t,o){a.textContent=t,a.className=`status ${o}`}function p(){return`http://localhost:${c}`}chrome.storage.local.get(["syncState","trackerPort"],t=>{u(t.syncState),c=t.trackerPort??3001,d.value=String(c)});chrome.storage.onChanged.addListener(t=>{t.syncState?.newValue&&u(t.syncState.newValue)});f.addEventListener("click",()=>{chrome.tabs.create({url:p()})});n.addEventListener("click",async()=>{n.disabled=!0,l("Syncing...","");let t=setTimeout(()=>{l("Sync timed out \u2014 is the tracker running?","error"),n.disabled=!1},8e3);try{let i=(await chrome.tabs.query({url:"http://localhost/*"})).filter(e=>{if(!e.url)return!1;try{return new URL(e.url).port===String(c)}catch{return!1}});if(i.length>0&&i[0].id!=null)try{await chrome.tabs.sendMessage(i[0].id,{type:"TRIGGER_SYNC"}),clearTimeout(t),setTimeout(async()=>{let e=await chrome.storage.local.get("syncState");u(e.syncState),n.disabled=!1},500)}catch{clearTimeout(t),l("Sync failed \u2014 reload the tracker tab","error"),n.disabled=!1}else{let e=r=>{r.syncState?.newValue&&(clearTimeout(t),chrome.storage.onChanged.removeListener(e),u(r.syncState.newValue),n.disabled=!1,s?.id!=null&&chrome.tabs.remove(s.id).catch(()=>{}))};chrome.storage.onChanged.addListener(e);let s=await chrome.tabs.create({url:p(),active:!1})}}catch{clearTimeout(t),l("Sync failed","error"),n.disabled=!1}});d.addEventListener("input",()=>{clearTimeout(m),m=setTimeout(()=>{let t=parseInt(d.value,10);!t||t<1||t>65535||(c=t,chrome.storage.local.set({trackerPort:t}),chrome.runtime.sendMessage({type:"SET_PORT",port:t}).catch(()=>{}))},400)});})();
