"use strict";(()=>{function h(t){let e=t.split(" / ")[0].trim(),n=e.indexOf(" - "),i=n>=0?e.slice(n+3).trim():e,o=i.match(/^(.+?)\s*\((\d{4,5})\)$/);return o?{colorName:o[1].trim(),colorCode:o[2]}:{colorName:i,colorCode:null}}var p={},l=null,m=[];function k(){let t=window.location.pathname.match(/\/products\/([^/?#]+)/);return t?t[1]:null}function v(){let t=document.querySelectorAll('script[type="application/ld+json"]');for(let e of t)try{let n=JSON.parse(e.textContent||"");if(n["@type"]==="ProductGroup"&&Array.isArray(n.hasVariant)){let i=new Map;for(let o of n.hasVariant){let{colorCode:r}=h(o.name||""),s=`${r??""}-${o.image??""}`;i.has(s)||i.set(s,{colorCode:r,sku:o.sku||"",imageUrl:o.image||""})}return Array.from(i.values())}}catch{}return[]}function q(){let t=document.querySelectorAll('a[href*="/products/"]');for(let e of t){let n=e.getAttribute("href")?.match(/\/products\/([^/?#]+)/);if(!n)continue;let i=n[1],o=e.closest("[class*='card']")||e.parentElement;if(!o)continue;let r=o.querySelector(".bbl-description");if(!r?.textContent)continue;let{colorCode:s}=h(r.textContent.trim());if(!s)continue;let u=`${i}::${s}`,c=p[u];if(!c||c.quantity<=0)continue;let a=o.querySelector("img");if(!a)continue;let y=a.closest(".ant-image")||a.parentElement;if(!y||y.querySelector(".ft-badge"))continue;let d=y,E=getComputedStyle(d);E.position==="static"&&(d.style.position="relative"),E.display==="inline"&&(d.style.display="block");let f=document.createElement("span");f.className="ft-badge",f.textContent=String(c.quantity),f.title=`You have ${c.quantity} in stock`,d.appendChild(f)}}function b(t){try{let e=new URL(t);return e.origin+e.pathname}catch{return t}}function w(t,e){if(t.colorCode){let i=p[`${e}::${t.colorCode}`];if(i)return i.quantity}let n=p[`${e}::${t.sku}`];return n?n.quantity:null}function x(){if(!l||m.length===0)return;document.querySelectorAll(".ft-badge").forEach(n=>n.remove());let t=new Map;for(let n of m)n.imageUrl&&t.set(b(n.imageUrl),n);let e=document.querySelectorAll(".ant-image-img, [class*='swatch'] img, [class*='color-option'] img");for(let n of e){let i=b(n.src),o=t.get(i);if(!o)continue;let r=w(o,l);if(r===null||r<=0)continue;let s=n.closest(".ant-image")||n.parentElement;if(!s||s.querySelector(".ft-badge"))continue;let u=s,c=getComputedStyle(u);c.position==="static"&&(u.style.position="relative"),c.display==="inline"&&(u.style.display="block");let a=document.createElement("span");a.className="ft-badge",a.textContent=String(r),a.title=`You have ${r} in stock`,u.appendChild(a)}}async function M(){return new Promise(t=>{chrome.runtime.sendMessage({type:"GET_LOOKUP"},e=>{e?.type==="LOOKUP_RESULT"&&(p=e.lookup),t()})})}function g(){x(),q()}async function C(){l=k(),l&&(m=v()),await M(),g(),new MutationObserver(()=>{g()}).observe(document.body,{childList:!0,subtree:!0})}function L(){let t=history.pushState.bind(history),e=history.replaceState.bind(history);history.pushState=function(...n){t(...n),S()},history.replaceState=function(...n){e(...n),S()},window.addEventListener("popstate",S)}async function S(){await new Promise(e=>setTimeout(e,100));let t=k();t&&t!==l?(l=t,m=v()):t||(l=null,m=[]),document.querySelectorAll(".ft-badge").forEach(e=>e.remove()),g()}chrome.runtime.onMessage.addListener(t=>{t.type==="STOCK_UPDATED"&&M().then(()=>g())});document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{L(),C()}):(L(),C());})();
