"use strict";(()=>{function h(t){let e=t.split(" / ")[0].trim(),n=e.indexOf(" - "),i=n>=0?e.slice(n+3).trim():e,o=i.match(/^(.+?)\s*\((\d{4,5})\)$/);return o?{colorName:o[1].trim(),colorCode:o[2]}:{colorName:i,colorCode:null}}var d={},c=null,m=[];function L(){let t=window.location.pathname.match(/\/products\/([^/?#]+)/);return t?t[1]:null}function k(){let t=document.querySelectorAll('script[type="application/ld+json"]');for(let e of t)try{let n=JSON.parse(e.textContent||"");if(n["@type"]==="ProductGroup"&&Array.isArray(n.hasVariant)){let i=new Map;for(let o of n.hasVariant){let{colorCode:r}=h(o.name||""),s=`${r??""}-${o.image??""}`;i.has(s)||i.set(s,{colorCode:r,sku:o.sku||"",imageUrl:o.image||""})}return Array.from(i.values())}}catch{}return[]}function M(){let t=document.querySelectorAll('a[href*="/products/"]');for(let e of t){let n=e.getAttribute("href")?.match(/\/products\/([^/?#]+)/);if(!n)continue;let i=n[1],o=e.closest("[class*='card']")||e.parentElement;if(!o)continue;let r=o.querySelector(".bbl-description");if(!r?.textContent)continue;let{colorCode:s}=h(r.textContent.trim());if(!s)continue;let l=`${i}::${s}`,u=d[l];if(!u||u.quantity<=0)continue;let a=o.querySelector("img");if(!a)continue;let g=a.closest(".ant-image")||a.parentElement;if(!g||g.querySelector(".ft-badge"))continue;let y=g;getComputedStyle(y).position==="static"&&(y.style.position="relative");let f=document.createElement("span");f.className="ft-badge",f.textContent=String(u.quantity),f.title=`You have ${u.quantity} in stock`,y.appendChild(f)}}function E(t){try{let e=new URL(t);return e.origin+e.pathname}catch{return t}}function q(t,e){if(t.colorCode){let i=d[`${e}::${t.colorCode}`];if(i)return i.quantity}let n=d[`${e}::${t.sku}`];return n?n.quantity:null}function w(){if(!c||m.length===0)return;document.querySelectorAll(".ft-badge").forEach(n=>n.remove());let t=new Map;for(let n of m)n.imageUrl&&t.set(E(n.imageUrl),n);let e=document.querySelectorAll(".ant-image-img, [class*='swatch'] img, [class*='color-option'] img");for(let n of e){let i=E(n.src),o=t.get(i);if(!o)continue;let r=q(o,c);if(r===null||r<=0)continue;let s=n.closest(".ant-image")||n.parentElement;if(!s||s.querySelector(".ft-badge"))continue;let l=s;getComputedStyle(l).position==="static"&&(l.style.position="relative");let a=document.createElement("span");a.className="ft-badge",a.textContent=String(r),a.title=`You have ${r} in stock`,l.appendChild(a)}}async function v(){return new Promise(t=>{chrome.runtime.sendMessage({type:"GET_LOOKUP"},e=>{e?.type==="LOOKUP_RESULT"&&(d=e.lookup),t()})})}function p(){w(),M()}async function C(){c=L(),c&&(m=k()),await v(),p(),new MutationObserver(()=>{p()}).observe(document.body,{childList:!0,subtree:!0})}function b(){let t=history.pushState.bind(history),e=history.replaceState.bind(history);history.pushState=function(...n){t(...n),S()},history.replaceState=function(...n){e(...n),S()},window.addEventListener("popstate",S)}async function S(){await new Promise(e=>setTimeout(e,100));let t=L();t&&t!==c?(c=t,m=k()):t||(c=null,m=[]),document.querySelectorAll(".ft-badge").forEach(e=>e.remove()),p()}chrome.runtime.onMessage.addListener(t=>{t.type==="STOCK_UPDATED"&&v().then(()=>p())});document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{b(),C()}):(b(),C());})();
